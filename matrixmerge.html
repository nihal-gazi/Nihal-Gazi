<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Matrix Merger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ExcelJS for Reading/Writing with Styles -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- NEW: jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- FIX: Added missing html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Mobile optimizations */
        body { font-family: 'Inter', sans-serif; }
        input[type="number"], input[type="text"] {
            font-size: 16px; /* Prevents iOS zoom on focus */
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-md mx-auto flex items-center gap-2">
            <i data-lucide="grid-3x3" class="w-6 h-6"></i>
            <h1 class="text-lg font-bold">Matrix Merger</h1>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <!-- Mode Selector -->
        <div class="flex bg-slate-200 p-1 rounded-xl">
            <button id="modeMatrixBtn" class="flex-1 text-sm font-bold py-2 px-3 rounded-lg bg-white text-blue-600 shadow transition-all">
                Matrix Merger (2 Files)
            </button>
            <button id="modeSingleBtn" class="flex-1 text-sm font-bold py-2 px-3 rounded-lg text-slate-600 transition-all">
                Single Column (1 File)
            </button>
        </div>

        <!-- Step 1: File Inputs -->
        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                Upload Files
            </h2>
            
            <!-- Matrix File Inputs -->
            <div id="fileInputsMatrix" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-700">File 1 (Data X)</label>
                    <input type="file" id="file1" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-700">File 2 (Data Y)</label>
                    <input type="file" id="file2" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                </div>
            </div>

            <!-- Single File Input (Hidden) -->
            <div id="fileInputsSingle" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-700">Excel File</label>
                    <input type="file" id="fileSingle" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
            </div>
        </section>

        <!-- Step 2: Configuration -->
        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                Configuration
            </h2>

            <!-- Matrix Col Inputs -->
            <div id="colInputsMatrix" class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Col Index X (File 1, A=1)</label>
                    <input type="number" id="colIndex1" value="1" min="1" class="w-full p-2 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Col Index Y (File 2, A=1)</label>
                    <input type="number" id="colIndex2" value="1" min="1" class="w-full p-2 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <!-- Single Col Input (Hidden) -->
            <div id="colInputsSingle" class="grid grid-cols-2 gap-4 mb-4 hidden">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Col Index (A=1)</label>
                    <input type="number" id="colIndexSingle" value="1" min="1" class="w-full p-2 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Split Row Index (1,2,3...)</label>
                    <input type="number" id="splitRowIndex" value="10" min="2" class="w-full p-2 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <!-- Common Inputs -->
            <div class="space-y-3 mb-4">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Top Header Text (Row 3)</label>
                    <div class="p-3 border rounded-lg bg-slate-50 space-y-2">
                        <!-- Row 1: Sem 1 Stream 1 -->
                        <div class="flex flex-wrap items-center gap-2">
                            <select id="h1_sem1" class="p-2 border rounded-lg bg-white w-20">
                                <option>1st</option>
                                <option>2nd</option>
                                <option>3rd</option>
                                <option>4th</option>
                                <option>5th</option>
                                <option>6th</option>
                                <option>7th</option>
                                <option>8th</option>
                            </select>
                            <span class="text-sm text-slate-700">Sem</span>
                            <input type="text" id="h1_stream1" placeholder="Stream" class="flex-1 p-2 border rounded-lg bg-white min-w-[100px]">
                            <span class="text-sm text-slate-700"> and</span>
                        </div>
                        <!-- Row 2: Sem 2 Stream 2 -->
                        <div class="flex flex-wrap items-center gap-2">
                            <select id="h1_sem2" class="p-2 border rounded-lg bg-white w-20">
                                <option>1st</option>
                                <option>2nd</option>
                                <option>3rd</option>
                                <option>4th</option>
                            </select>
                            <span class="text-sm text-slate-700">Sem</span>
                            <input type="text" id="h1_stream2" placeholder="Stream" class="flex-1 p-2 border rounded-lg bg-white min-w-[100px]">
                            <span class="text-sm text-slate-700"></span>
                        </div>
                        <!-- Row 3: Exam Year -->
                        <div class="flex flex-wrap items-center gap-2">
                            <select id="h1_odd_even" class="p-2 border rounded-lg bg-white flex-1">
                                <option>Odd</option>
                                <option>Even</option>
                            </select>
                            <span class="text-sm text-slate-700">Semester Exam -</span>
                            <input type="text" id="h1_year" placeholder="Year" class="p-2 border rounded-lg bg-white w-24">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Sub Header Text (Row 4)</label>
                    <div class="flex items-center gap-2 p-3 border rounded-lg bg-slate-50">
                        <span class="text-sm font-medium text-slate-700">Arrangement of Seat - Room No -</span>
                        <input type="text" id="h2_room_num" placeholder="Room No" class="p-2 border rounded-lg bg-white w-24 flex-1">
                    </div>
                </div>
            </div>
			
			
			
			<div class="flex items-center gap-3 p-3 border rounded-lg bg-slate-50">
				<input type="checkbox" id="autoIncrementRoom" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500 border-slate-300">
				<label for="autoIncrementRoom" class="text-sm font-medium text-slate-700">
					Auto-increment sub-room number (e.g., 3.1, 3.2...)
				</label>
			</div>

			<br>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Rows (M)</label>
                    <input type="number" id="rowsM" value="10" min="1" class="w-full p-2 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Columns (N)</label>
                    <input type="number" id="colsN" value="6" min="1" class="w-full p-2 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
        </section>

        <!-- Step 3: Styling -->
        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
                Styling
            </h2>

            <div class="space-y-4">
                <!-- Header 1 Style -->
                <div class="p-3 bg-black/10 rounded-lg border border-slate-100">
                    <p class="text-xs font-bold text-slate-600 mb-2">Header 1 Styling (Row 3)</p>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] text-slate-400">Font Color</label>
                            <div class="flex items-center gap-2 h-8">
                                <input type="color" id="h1Color" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] text-slate-400">Size</label>
                            <input type="number" id="h1Size" value="18" class="w-full h-8 px-2 text-sm border rounded">
                        </div>
                    </div>
                </div>

                <!-- Header 2 Style -->
                <div class="p-3 bg-red-50 rounded-lg border border-red-100">
                    <p class="text-xs font-bold text-slate-600 mb-2">Header 2 Styling (Row 4)</p>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] text-slate-400">Font Color</label>
                            <div class="flex items-center gap-2 h-8">
                                <input type="color" id="h2Color" value="#FF0000" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] text-slate-400">Size</label>
                            <input type="number" id="h2Size" value="18" class="w-full h-8 px-2 text-sm border rounded">
                        </div>
                    </div>
                </div>

                <!-- X Data Style -->
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <p class="text-xs font-bold text-blue-600 mb-2">Data X Styling</p>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] text-blue-400">Font Color</label>
                            <div class="flex items-center gap-2 h-8">
                                <input type="color" id="xColor" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] text-blue-400">Size</label>
                            <input type="number" id="xSize" value="14" class="w-full h-8 px-2 text-sm border rounded">
                        </div>
                    </div>
                </div>

                <!-- Y Data Style -->
                <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                    <p class="text-xs font-bold text-green-600 mb-2">Data Y Styling</p>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] text-green-400">Font Color</label>
                            <div class="flex items-center gap-2 h-8">
                                <input type="color" id="yColor" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] text-green-400">Size</label>
                            <input type="number" id="ySize" value="14" class="w-full h-8 px-2 text-sm border rounded">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Action -->
        <div class="space-y-3">
            <button id="previewBtn" class="w-full bg-slate-100 text-slate-700 font-bold py-3 rounded-xl border border-slate-300 active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i data-lucide="eye" class="w-5 h-5"></i>
                Update Preview
            </button>
            <button id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i data-lucide="download" class="w-5 h-5"></i>
                Generate Excel
            </button>
            <!-- NEW: PDF Button -->
            <button id="pdfBtn" class="w-full bg-gradient-to-r from-red-600 to-rose-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                Generate PDF
            </button>
        </div>

        <div id="status" class="hidden text-center text-sm p-2 rounded bg-slate-200 text-slate-700 animate-pulse">
            Processing...
        </div>

        <!-- Preview Area -->
        <div id="previewArea" class="mt-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 overflow-x-auto">
            <p class="text-sm text-slate-400 text-center">Click "Update Preview" to see your matrix here.</p>
        </div>

    </main>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.6/purify.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <script>
	// Initialize Icons
        lucide.createIcons();

        let activeMode = 'matrix'; // 'matrix' or 'single'

        // --- NEW: Mode Toggles ---
        const modeMatrixBtn = document.getElementById('modeMatrixBtn');
        const modeSingleBtn = document.getElementById('modeSingleBtn');
        
        const fileInputsMatrix = document.getElementById('fileInputsMatrix');
        const fileInputsSingle = document.getElementById('fileInputsSingle');
        const colInputsMatrix = document.getElementById('colInputsMatrix');
        const colInputsSingle = document.getElementById('colInputsSingle');

        modeMatrixBtn.addEventListener('click', () => {
            activeMode = 'matrix';
            modeMatrixBtn.classList.add('bg-white', 'text-blue-600', 'shadow');
            modeSingleBtn.classList.remove('bg-white', 'text-blue-600', 'shadow');
            modeSingleBtn.classList.add('text-slate-600');
            
            fileInputsMatrix.classList.remove('hidden');
            colInputsMatrix.classList.remove('hidden');
            fileInputsSingle.classList.add('hidden');
            colInputsSingle.classList.add('hidden');
        });

        modeSingleBtn.addEventListener('click', () => {
            activeMode = 'single';
            modeSingleBtn.classList.add('bg-white', 'text-blue-600', 'shadow');
            modeMatrixBtn.classList.remove('bg-white', 'text-blue-600', 'shadow');
            modeMatrixBtn.classList.add('text-slate-600');

            fileInputsSingle.classList.remove('hidden');
            colInputsSingle.classList.remove('hidden');
            fileInputsMatrix.classList.add('hidden');
            colInputsMatrix.classList.add('hidden');
        });
        // --- End Mode Toggles ---


        async function readColumnFromExcel(file, colIndex) {
            const workbook = new ExcelJS.Workbook();
            const arrayBuffer = await file.arrayBuffer();
            await workbook.xlsx.load(arrayBuffer);
            
            const worksheet = workbook.worksheets[0]; // Read first sheet
            const data = [];
            
            worksheet.eachRow((row, rowNumber) => {
                // colIndex is 0-based, getCell is 1-based
                const cell = row.getCell(parseInt(colIndex) + 1);
                const val = cell.value;
                // Push empty string for null/undefined to keep row indices correct
                data.push(val ? val.toString() : "");
            });
            return data;
        }

        const generateBtn = document.getElementById('generateBtn');
        const previewBtn = document.getElementById('previewBtn');
        const pdfBtn = document.getElementById('pdfBtn'); // FIX: Was 'generatePdfBtn'

        generateBtn.addEventListener('click', () => runGenerationLogic('excel'));
        previewBtn.addEventListener('click', () => runGenerationLogic('preview'));
        pdfBtn.addEventListener('click', generatePDF); // NEW

        // PDF Generation Function
 async function generatePDF() {
            const statusEl = document.getElementById('status');
            const generateBtn = document.getElementById('generateBtn');
            const previewBtn = document.getElementById('previewBtn');
            const pdfBtn = document.getElementById('pdfBtn');
			var room_increment = document.getElementById("autoIncrementRoom").checked;
            const buttons = [generateBtn, previewBtn, pdfBtn];
			
			

            try {
                statusEl.textContent = "Generating PDF...";
                statusEl.classList.remove('hidden');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-75');
                });

                // 1. We MUST run 'preview' logic first to get all the data
                // This call populates all our variables.
                const data = await runGenerationLogic('preview', true); 
                
                if (!data) {
                    throw new Error("Could not read data. Please check files and settings.");
                }

                // Destructure all the data we need
                const { dataX, dataY, styles, rowsM, colsN, head1Txt, head2Txt } = data;
				var room_data = head2Txt.split(/\./);
				var room_prefix = room_data[0];
				var room_suffix = room_data[1];

                // 2. Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt', 'a4'); // Portrait, points, A4

                // 3. Set up pointers and loop
                let ptrX = (activeMode === 'matrix') ? 1 : 0;
                let ptrY = (activeMode === 'matrix') ? 1 : 0;
                if (activeMode === 'single') { ptrX = 0; ptrY = 0; }
				
				
                
                let sheetCount = 1;
                let isFirstPage = true;

                while (ptrX < dataX.length || ptrY < dataY.length) {
                    
                    if (!isFirstPage) {
                        doc.addPage();
                    }

                    // --- Build Column Headers ---
                    // e.g., ['Column 1', 'Column 2', 'Column 3']
                    const tableHead = [];
                    for (let c = 0; c < colsN; c++) {
                        tableHead.push(`Column ${c + 1}`);
                    }

                    // --- Build Table Body ---
                    // e.g., [['a1', 'x2', 'a4'], ['x1', 'a3', 'x4'], ...]

                    // We will build an array of cell objects, not just strings
                    const tableBody = [];
                    
                    for (let r = 0; r < rowsM; r++) {
                        const tableRow = [];
                        for (let c = 0; c < colsN; c++) {
                            const isTypeX = (r + c) % 2 === 0;
                            let val, styleKey;

                            if (isTypeX) {
                                val = ptrX < dataX.length ? dataX[ptrX] : "";
                                styleKey = 'x';
                                ptrX++;
                            } else {
                                val = ptrY < dataY.length ? dataY[ptrY] : "";
                                styleKey = 'y';
                                ptrY++;
                            }

                            // Create a cell object with content AND styles
                            const cell = {
                                content: val,
                                styles: {
                                    fontSize: styles[styleKey].size,
                                    textColor: styles[styleKey].colorHex
                                }
                            };
                            tableRow.push(cell);
                        }
                        tableBody.push(tableRow);
                    }

                    // --- Draw to PDF ---
					
					
					
					var head2Txt_pdf = `Arrangement of Seat - Room No - ${room_prefix}.${room_suffix}`;
					
					// lol...just increase cuz thats what was told
					if(room_increment){
						room_suffix++;
					}
					
					
					
                    doc.autoTable({
                        // 'didDrawPage' is a hook that lets us add custom
                        // content before the table is drawn. This is
                        // perfect for our headers.
                        didDrawPage: function (hookData) {
                            // --- Define page center and usable width ---
                            const centerX = doc.internal.pageSize.getWidth() / 2;
                            const usableWidth = doc.internal.pageSize.getWidth() - 80; // 40pt margin each side

                            // "Seating Room X" Title
                            doc.setFontSize(16);
                            doc.setFont(undefined, 'bold');
                            doc.text(`Seating Room ${sheetCount}`, centerX, 40, { align: 'center' });

                            // Header 1
                            doc.setFontSize(styles.h1.size);
                            doc.setTextColor(styles.h1.colorHex);
                            doc.text(head1Txt, centerX, 70, { 
                                maxWidth: usableWidth, // <-- FIX: Add max width
                                align: 'center' 
                            });
                            
                            // Header 2
                            doc.setFontSize(styles.h2.size);
                            doc.setTextColor(styles.h2.colorHex);
                            doc.text(head2Txt_pdf, centerX, 115, { // <-- FIX: Pushed down from 95
                                maxWidth: usableWidth, // <-- FIX: Add max width
                                align: 'center' 
                            });
                        },
                        
                        // Where the table itself should start on the page
                        margin: { top: 140 },
                        
                        head: [tableHead], // The ['Column 1', ...]
                        body: tableBody,   // The [['a1', 'x2', ...], ...]
                        
                        // Styling for the table
                        headStyles: {
                            fillColor: [241, 245, 249], // slate-100
                            textColor: [15, 23, 42],    // slate-800
                            fontStyle: 'bold',
                            halign: 'center',
                            fontSize: 14, // Hardcoding a size that won't overlap
							lineColor: [100, 116, 139], // A gray slate border
                            lineWidth: 0.5
                        },
                        bodyStyles: {
                            halign: 'center',
                            valign: 'middle',
                            minCellHeight: 30, // Similar to our 60px / 2
							lineColor: [100, 116, 139], // A gray slate border
                            lineWidth: 0.5
                        },
                        // This hook lets us style individual cells (X vs Y)
                        // This is optional but nice to have
                        
						
						
						//removed diddrawcell
						
							
                    });

                    sheetCount++;
                    isFirstPage = false;
                }
                
                // 4. Save the PDF
                doc.save('matrix_output.pdf');

                statusEl.textContent = "PDF Generated!";
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-75');
                    });
                }, 2000);

            } catch (err) {
                console.error(err);
                showModal(`PDF Error: ${err.message}. Check console.`);
                statusEl.textContent = "Error";
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-75');
                });
            }
        }


        async function runGenerationLogic(outputType = 'excel', isPdfCall = false) {
            const statusEl = document.getElementById('status');
            
            let dataX, dataY; // Declare data arrays
            
            try {
                // MODIFIED: Only show status if not called by PDF
                // The PDF function will be managing its own status.
                if (outputType !== 'preview') {
                    statusEl.textContent = "Reading files...";
                    statusEl.classList.remove('hidden');
                }
                
                // MODIFIED: Disable only if not PDF
                if (outputType !== 'preview') {
                    generateBtn.disabled = true;
                    previewBtn.disabled = true;
                    if (pdfBtn) pdfBtn.disabled = true;
                    generateBtn.classList.add('opacity-75');
                    previewBtn.classList.add('opacity-75');
                    if (pdfBtn) pdfBtn.classList.add('opacity-75');
                } else {
                    // If it IS preview, reset the status text
                    statusEl.textContent = "Generating preview...";
                    statusEl.classList.remove('hidden');
                }


                // --- Mode-based data loading ---
                if (activeMode === 'matrix') {
                    const file1Input = document.getElementById('file1');
                    const file2Input = document.getElementById('file2');

                    if (!file1Input.files[0] || !file2Input.files[0]) {
                        showModal("Please select both Excel files for Matrix Mode.");
                        statusEl.classList.add('hidden');
                        generateBtn.disabled = false;
                        previewBtn.disabled = false;
                    generateBtn.classList.remove('opacity-75');
                    previewBtn.classList.remove('opacity-75');
                    // NEW:
                    if (pdfBtn) {
                        pdfBtn.disabled = false;
                        pdfBtn.classList.remove('opacity-75');
                    }
                    return; // NEW: Added missing return
                }

                // MOVED: These lines now inside the 'if' block
                const colX_matrix = parseInt(document.getElementById('colIndex1').value) - 1;
                const colY_matrix = parseInt(document.getElementById('colIndex2').value) - 1;
                
                dataX = await readColumnFromExcel(file1Input.files[0], colX_matrix);
                dataY = await readColumnFromExcel(file2Input.files[0], colY_matrix);

            } else { // activeMode === 'single'
                // REMOVED: Extra '}' from before 'else'
                const fileSingleInput = document.getElementById('fileSingle');
                
                if (!fileSingleInput.files[0]) {
                    showModal("Please select an Excel file for Single Column Mode.");
                    statusEl.classList.add('hidden');
                    generateBtn.disabled = false;
                    previewBtn.disabled = false;
                    generateBtn.classList.remove('opacity-75');
                    previewBtn.classList.remove('opacity-75');
                    if (pdfBtn) {
                        pdfBtn.disabled = false;
                        pdfBtn.classList.remove('opacity-75');
                    }
                    return; // NEW: Added missing return
                }

                const colX_single = parseInt(document.getElementById('colIndexSingle').value) - 1;
                // User's 1-based "split row" index.
                const splitIndex = parseInt(document.getElementById('splitRowIndex').value); 
                
                const allData = await readColumnFromExcel(fileSingleInput.files[0], colX_single);
                
                // In single mode, row 0 is the header, data starts at 1.
                // Slice(1, splitIndex) goes from index 1 up to (but not including) splitIndex.
                // This is correct as user's 1-based index matches array length.
                dataX = allData.slice(1, splitIndex); 
                dataY = allData.slice(splitIndex);

                // REQ 2 Fix: Pointers for single mode must start at 0
                // This is handled by the ptrX/ptrY init logic later
            }
            // --- End data loading ---


            // 2. Setup Common Variables
                const rowsM = parseInt(document.getElementById('rowsM').value);
                const colsN = parseInt(document.getElementById('colsN').value);
                
                // Assemble Header 1 from multiple inputs
                const sem1 = document.getElementById('h1_sem1').value;
                const stream1 = document.getElementById('h1_stream1').value;
                const sem2 = document.getElementById('h1_sem2').value;
                const stream2 = document.getElementById('h1_stream2').value;
                const oddEven = document.getElementById('h1_odd_even').value; 
                const year = document.getElementById('h1_year').value;
				var room_increment = document.getElementById("autoIncrementRoom").checked;
                const head1Txt = `${sem1} Sem ${stream1} and ${sem2} Sem ${stream2} ${oddEven} Semester Examination - ${year}`;

                // Assemble Header 2 from multiple inputs
                const roomNum = document.getElementById('h2_room_num').value; 
				
				var room_data = roomNum.split(/\./);
				var room_prefix = room_data[0];
				var room_suffix = room_data[1];
				// console.log(room_data)
				
                var head2Txt = roomNum + "";
				


                // Styles
                const h1ColorHex = document.getElementById('h1Color').value;
                const h2ColorHex = document.getElementById('h2Color').value;
                const xColorHex = document.getElementById('xColor').value;
                const yColorHex = document.getElementById('yColor').value;

                const styles = {
                    h1: { 
                        color: { argb: h1ColorHex.replace('#', 'FF') },
                        size: parseInt(document.getElementById('h1Size').value),
                        colorHex: h1ColorHex
                    },
                    h2: { 
                        color: { argb: h2ColorHex.replace('#', 'FF') },
                        size: parseInt(document.getElementById('h2Size').value),
                        colorHex: h2ColorHex
                    },
                    x: { 
                        color: { argb: xColorHex.replace('#', 'FF') },
                        size: parseInt(document.getElementById('xSize').value),
                        colorHex: xColorHex
                    },
                    y: { 
                        color: { argb: yColorHex.replace('#', 'FF') },
                        size: parseInt(document.getElementById('ySize').value),
                        colorHex: yColorHex
                    }
                };
                
                // Border definition
                const allBorders = {
                    top: {style:'thin'},
                    left: {style:'thin'},
                    bottom: {style:'thin'},
                    right: {style:'thin'}
                };

                // NEW: Initialize pointers ONCE here, before the output type check.
                // This ensures they are shared and incremented across the entire generation process
                // for both preview and excel.
                let ptrX = (activeMode === 'matrix') ? 1 : 0;
                let ptrY = (activeMode === 'matrix') ? 1 : 0;
                if (activeMode === 'single') {
                    ptrX = 0;
                    ptrY = 0;
                }

                // 3. Output based on type
			if (outputType === 'preview') {
                    statusEl.textContent = "Generating preview...";

                    // --- Generate HTML Preview Table (with looping) ---
                    let previewHtml = '';
                    let sheetCount = 1;

                    // Run loop as long as there is data left
                    while (ptrX < dataX.length || ptrY < dataY.length) {

                        if (sheetCount > 1) {
                            previewHtml += '<div style="height: 30px; border-bottom: 2px dashed #94a3b8; margin: 20px 0;"></div>';
                        }
                        
                        previewHtml += `<h4 class="text-lg font-bold text-slate-700 mb-2">Seating Room ${sheetCount}</h4>`;
                        
                        let previewGrid = Array(rowsM).fill(null).map(() => Array(colsN).fill(null));

                        for (let c = 0; c < colsN; c++) {
                            for (let r = 0; r < rowsM; r++) {
                                const isTypeX = (r + c) % 2 === 0;
                                let val, styleKey;

                                if (isTypeX) {
                                    val = ptrX < dataX.length ? dataX[ptrX] : "";
                                    styleKey = 'x';
                                    ptrX++;
                                } else {
                                    val = ptrY < dataY.length ? dataY[ptrY] : "";
                                    styleKey = 'y';
                                    ptrY++;
                                }
                                previewGrid[r][c] = { value: val, styleKey: styleKey };
                            }
                        }
						
						//only increase room suffix, as no other instruction was given lol
						console.log(room_increment);
						  
						
						var head2Txt = `Arrangement of Seat - Room No - ${room_prefix}.${room_suffix}`;
						
						
						
						console.log(head2Txt);	
						
						if(room_increment){
							room_suffix++;
						}

						
                        previewHtml += '<table class="w-full border-collapse border border-slate-300 text-sm text-center">';
                        previewHtml += `<thead>`;
                        previewHtml += `<tr><td colspan="${colsN}" style="padding: 4px;"></td></tr>`;
                        previewHtml += `<tr><td colspan="${colsN}" style="padding: 4px;"></td></tr>`;
                        previewHtml += `<tr style="height: 30px;"><th colspan="${colsN}" style="color: ${styles.h1.colorHex}; font-size: ${styles.h1.size}px; font-weight: bold; padding: 4px; border: 1px solid #cbd5e1;">${head1Txt}</th></tr>`;
                        previewHtml += `<tr style="height: 35.1px;"><th colspan="${colsN}" style="color: ${styles.h2.colorHex}; font-size: ${styles.h2.size}px; font-weight: bold; text-decoration: underline; padding: 4px; border: 1px solid #cbd5e1;">${head2Txt}</th></tr>`;
                        previewHtml += `<tr><td colspan="${colsN}" style="padding: 4px; border: 1px solid #cbd5e1;"></td></tr>`;
                        previewHtml += `<tr style="height: 25.2px;">`;
                        for (let c = 0; c < colsN; c++) {
                            previewHtml += `<th style="border: 1px solid #cbd5e1; font-weight: bold; padding: 4px; font-size: 20px;">Column ${c + 1}</th>`;
                        }
                        previewHtml += `</tr>`;
                        previewHtml += `</thead>`;
                        previewHtml += '<tbody>';

                        for (let r = 0; r < rowsM; r++) {
                            previewHtml += '<tr>';
                            for (let c = 0; c < colsN; c++) {
                                const item = previewGrid[r][c];
                                const style = styles[item.styleKey] || styles['x'];
                                previewHtml += `<td style="color: ${style.colorHex}; font-size: ${style.size}px; border: 1px solid #cbd5e1; padding: 8px 4px; height: 60px; white-space: nowrap; vertical-align: middle;">${item.value}</td>`;
                            }
                            previewHtml += '</tr>';
                        }
                        previewHtml += '</tbody></table>';

                        sheetCount++;
                    } // End of while loop

                    // Update the HTML on the page
                    document.getElementById('previewArea').innerHTML = previewHtml;

                    // --- THIS IS THE NEW LOGIC ---
                    // If this function was called by generatePDF...
                    if (isPdfCall) {
                        // ...return the raw data object for AutoTable.
						head2Txt = roomNum + "";
                        return { dataX, dataY, styles, rowsM, colsN, head1Txt, head2Txt, allBorders };
                    } 
                    // ...otherwise (if 'Update Preview' was clicked)...
                    else {
                        // ...just do the normal button/status update.
                        statusEl.textContent = "Preview updated!";
                        setTimeout(() => {
                            statusEl.classList.add('hidden');
                            generateBtn.disabled = false;
                            previewBtn.disabled = false;
                            if (pdfBtn) pdfBtn.disabled = false;
                            generateBtn.classList.remove('opacity-75');
                            previewBtn.classList.remove('opacity-75');
                            if (pdfBtn) pdfBtn.classList.remove('opacity-75');
                        }, 2000);
                        // And return the HTML string (like before)
                        return previewHtml; 
                    }
                    // --- END OF NEW LOGIC ---
                }
			else { // outputType === 'excel'
                    // REQ 2: Generate Excel with Carry-over Logic
                    statusEl.textContent = "Generating file with all data...";
                    const wb = new ExcelJS.Workbook();

                    // Pointers must be initialized *inside* the excel block
                    // to reset every time generate is clicked.
                    // DELETED: Pointers are now initialized outside
                    // let ptrX = (activeMode === 'matrix') ? 1 : 0; ...
                    // let ptrY = (activeMode === 'matrix') ? 1 : 0; ...

                    let sheetCount = 1;
                    // Run loop as long as there is data left in EITHER array
					
					room_data = head2Txt.split(/\./);
					room_prefix = room_data[0];
					room_suffix = room_data[1];
					
                    while (ptrX < dataX.length || ptrY < dataY.length) {
                        const ws = wb.addWorksheet(`Matrix Result ${sheetCount}`);

						head2Txt = `Arrangement of Seat - Room No - ${room_prefix}.${room_suffix}`;

						// lol only suffix inc, cuz thats what we r told
						if(room_increment){
							room_suffix++;
						}
                        
                        // --- Start Sheet Generation Logic ---
                        // Copied from preview logic
                        ws.mergeCells(3, 1, 3, colsN);
                        ws.getRow(3).height = 30; // NEW: Height 30
                        const cellH1 = ws.getCell(3, 1);
                        cellH1.value = head1Txt;
                        cellH1.font = { color: styles.h1.color, size: styles.h1.size, bold: true };
                        cellH1.alignment = { horizontal: 'center' };
                        cellH1.border = allBorders; // REQ 3

                        ws.mergeCells(4, 1, 4, colsN);
                        ws.getRow(4).height = 35.1; // NEW: Height 35.1
                        const cellH2 = ws.getCell(4, 1);
                        cellH2.value = head2Txt;
                        cellH2.font = { color: styles.h2.color, size: styles.h2.size, bold: true, underline: true };
                        cellH2.alignment = { horizontal: 'center' };
                        cellH2.border = allBorders; // REQ 3

                        ws.mergeCells(5, 1, 5, colsN);
                        const cellGap = ws.getCell(5, 1);
                        cellGap.border = allBorders; // REQ 3

                        ws.getRow(6).height = 25.2; // NEW: Height 25.2
                        for (let c = 0; c < colsN; c++) {
                            const colHeaderCell = ws.getCell(6, c + 1);
                            colHeaderCell.value = `Column ${c + 1}`;
                            colHeaderCell.font = { bold: true, size: 20 }; // REQ 1: Size 20
                            colHeaderCell.alignment = { horizontal: 'center' };
                            colHeaderCell.border = allBorders;
                        }

                        const startRow = 7;
                        
                        // Set column widths first
                        for (let c = 0; c < colsN; c++) {
                            ws.getColumn(c + 1).width = 27;
                        }

                        // NEW: Swapped loops to be COLUMN-MAJOR (outer loop c, inner loop r)
                        // This matches the original seating logic.
                        for (let c = 0; c < colsN; c++) {
                            for (let r = 0; r < rowsM; r++) {
                                // Set row height (only needs to be done on first column)
                                if (c === 0) {
                                    ws.getRow(startRow + r).height = 60;
                                }

                                const cell = ws.getCell(startRow + r, c + 1);
                                const isTypeX = (r + c) % 2 === 0;
                                let val, styleKey;

                                if (isTypeX) {
                                    val = ptrX < dataX.length ? dataX[ptrX] : "";
                                    styleKey = 'x';
                                    ptrX++; // Increment pointer
                                } else {
                                    val = ptrY < dataY.length ? dataY[ptrY] : "";
                                    styleKey = 'y';
                                    ptrY++; // Increment pointer
                                }
                                
                                cell.value = val;
                                cell.font = { color: styles[styleKey].color, size: styles[styleKey].size };
                                cell.border = allBorders;
                                cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true};
                            }
                        }
                        // --- End Sheet Generation Logic ---

                        sheetCount++;
                        // Loop will check condition (ptrX < dataX.length || ptrY < dataY.length) again
                    }

                    // Save File
                    const buffer = await wb.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    saveAs(blob, "matrix_output.xlsx");

                    statusEl.textContent = "Done!";
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                        generateBtn.disabled = false;
                        previewBtn.disabled = false;
                        if (pdfBtn) pdfBtn.disabled = false;
                        generateBtn.classList.remove('opacity-75');
                        previewBtn.classList.remove('opacity-75');
                        if (pdfBtn) pdfBtn.classList.remove('opacity-75');
                    }, 2000);
                }

            } catch (err) {
                console.error(err);
                showModal("Error processing files. Check console for details.");
                statusEl.textContent = "Error";
                generateBtn.disabled = false;
                previewBtn.disabled = false;
                if (pdfBtn) pdfBtn.disabled = false;
                generateBtn.classList.remove('opacity-75');
                previewBtn.classList.remove('opacity-75');
                if (pdfBtn) pdfBtn.classList.remove('opacity-75');
            }
        }

        // --- Custom Alert Modal ---
        // Create modal elements once
        const modalBg = document.createElement('div');
        modalBg.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden";
        
        const modalBox = document.createElement('div');
        modalBox.className = "bg-white rounded-lg shadow-xl p-6 max-w-sm w-full";
        
        const modalTitle = document.createElement('h3');
        modalTitle.className = "text-lg font-bold text-slate-800 mb-2";
        modalTitle.innerText = "Notice";

        const modalMessage = document.createElement('p');
        modalMessage.className = "text-sm text-slate-600 mb-4";
        
        const modalCloseBtn = document.createElement('button');
        modalCloseBtn.className = "w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg";
        modalCloseBtn.innerText = "OK";
        
        modalBox.append(modalTitle, modalMessage, modalCloseBtn);
        modalBg.append(modalBox);
        document.body.append(modalBg);

        modalCloseBtn.addEventListener('click', () => {
            modalBg.classList.add('hidden');
        });

        function showModal(message) {
            modalMessage.innerText = message;
            modalBg.classList.remove('hidden');
        }

        // Replace native alert
        window.alert = showModal;
    </script>
</body>
</html>
